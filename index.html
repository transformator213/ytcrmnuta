<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube CRM  (NUTA)</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: #020617; color: #e5e7eb; }
    .app { max-width: 1100px; margin: auto; padding: 16px; }
    h1 { text-align: center; margin-bottom: 14px; font-size: 1.4rem; }
    h2 { font-size: 1.1rem; margin: 10px 0 6px; }

    .card {
      background: #020617;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
      margin-bottom: 16px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
      display: none; /* –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –¥–æ –ø–∞—Ä–æ–ª—é */
    }

    .summary-item {
      background: #0b1120;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
      font-size: .9rem;
    }
    .summary-item span {
      display: block;
      margin-top: 4px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #22c55e;
    }

    .public-summary-item {
      background: #0b1120;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: .9rem;
    }
    .public-summary-item span {
      display: block;
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 4px;
      color:#22c55e;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.9rem;
      font-weight: 500;
      background: #22c55e;
      color: #020617;
    }
    button.secondary { background: #1f2937; color: #e5e7eb; }
    button.danger { background: #ef4444; color: #fff; }
    button.small { padding: 3px 7px; font-size: .75rem; }

    input[type="date"], input[type="number"], input[type="text"] {
      width: 100%; padding: 6px; border-radius: 6px;
      border: 1px solid #374151; background: #020617; color: #e5e7eb;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 4px; border-bottom: 1px solid #1f2937; }

    .calendar-toggle-cell { text-align:center; cursor:pointer; }
    .calendar-toggle-cell.checked { background:#16a34a;color:#fff; }

    .channel-block { padding:10px;border:1px solid #1f2937;border-radius:10px;margin-bottom:8px; }
    .calendar-wrapper { border:1px solid #1f2937;padding:8px;border-radius:8px;margin-top:6px; }
  </style>

  <!-- Firebase (compat SDK, —â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
</head>
<body>
<div class="app">
  <h1>YouTube CRM (NUTA)</h1>

  <!-- üîê –ú–µ–Ω–µ–¥–∂–µ—Ä—Å—å–∫–∏–π –¥–æ—Å—Ç—É–ø -->
  <button id="managerBtn">–ú–µ–Ω–µ–¥–∂–µ—Ä—Å—å–∫–∏–π –¥–æ—Å—Ç—É–ø</button>
  <div id="passBlock" style="display:none;margin:8px 0;">
    <input id="passInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:160px;">
    <button id="passOk">–£–≤—ñ–π—Ç–∏</button>
  </div>

  <!-- üü¢ –ü–£–ë–õ–Ü–ß–ù–ê –ê–ù–ê–õ–Ü–¢–ò–ö–ê (–≤–∏–¥–Ω–æ –≤—Å—ñ–º) -->
  <div class="card">
    <h2>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏</h2>

    <div class="public-summary-item">
      –ì–æ—Ç–æ–≤—ñ, –∞–ª–µ –Ω–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω—ñ
      <span id="stockPublic">0</span>
    </div>

    <div class="public-summary-item">
      –ó–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ –ø—ñ–¥ –∫–∞–Ω–∞–ª–∏
      <span id="reservedPublic">0</span>
    </div>

    <label style="margin-top:10px;">–ù–æ—Ä–º–∞ –≤—ñ–¥–µ–æ / –¥–µ–Ω—å</label>
    <input id="normInput" type="number" value="11">
  </div>

  <!-- üü° –ü–û–í–ù–ê –ê–ù–ê–õ–Ü–¢–ò–ö–ê (—Ç—ñ–ª—å–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä) -->
  <div class="card summary-grid">
    <div class="summary-item">–í—Å—å–æ–≥–æ –∑—Ä–æ–±–ª–µ–Ω–æ<span id="totalMade">0</span></div>
    <div class="summary-item">–í—Å—å–æ–≥–æ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ<span id="totalPublished">0</span></div>
    <div class="summary-item">–ü–æ–≤–Ω—ñ –ø–∞–∫–µ—Ç–∏ –ø–æ 15<span id="packs">0</span></div>
    <div class="summary-item">–©–µ –∫–∞–Ω–∞–ª—ñ–≤ –º–æ–∂–Ω–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏<span id="extraChannels">0</span></div>
  </div>

  <!-- –î–ù–Ü -->
  <div class="card">
    <h2>–î–Ω—ñ (–≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ)</h2>
    <button id="addToday">+ –î–µ–Ω—å (—Å—å–æ–≥–æ–¥–Ω—ñ)</button>
    <button id="addDay" class="secondary">+ –ü–æ—Ä–æ–∂–Ω—ñ–π –¥–µ–Ω—å</button>

    <table style="margin-top:10px;">
      <thead><tr><th>–î–∞—Ç–∞</th><th>–ü–ª–∞–Ω</th><th>–ó—Ä–æ–±–ª–µ–Ω–æ</th><th></th></tr></thead>
      <tbody id="daysBody"></tbody>
    </table>
  </div>

  <!-- –ö–ê–ù–ê–õ–ò -->
  <div class="card">
    <h2>–ö–∞–Ω–∞–ª–∏</h2>
    <button id="addChannel">+ –î–æ–¥–∞—Ç–∏ –∫–∞–Ω–∞–ª</button>
    <div id="channels"></div>
  </div>

</div>

<script>
const STORAGE="ytcrm";
let manager=false;
let state={norm:11,days:[],channels:[]};

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCIcE8JVuUVj2Vz0SwSSBVPeFGizeso_Os",
  authDomain: "yt-crm-nuta.firebaseapp.com",
  projectId: "yt-crm-nuta",
  storageBucket: "yt-crm-nuta.firebasestorage.app",
  messagingSenderId: "290336884832",
  appId: "1:290336884832:web:f253d071eeaf9ca8e09b05",
  databaseURL: "https://yt-crm-nuta-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–µ—Å—å state —É Firebase
function save(){
  db.ref("state").set(state).catch(e=>console.error("Save error", e));
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ state –∑ Firebase (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ)
function load(callback){
  db.ref("state").once("value").then(snap=>{
    const data = snap.val();
    if(data){
      state = {
        norm: data.norm ?? 11,
        days: Array.isArray(data.days) ? data.days : [],
        channels: Array.isArray(data.channels) ? data.channels : []
      };
    }
    if(callback) callback();
  }).catch(err=>{
    console.error("Load error", err);
    if(callback) callback();
  });
}

// ---- DAYS ----
function renderDays(){
 let b=document.getElementById("daysBody"); b.innerHTML="";
 state.days.forEach((d,i)=>{
  b.innerHTML+=`
  <tr>
   <td><input type="date" value="${d.date||""}" onchange="state.days[${i}].date=this.value;save();"></td>
   <td><input type="number" value="${d.planned||state.norm}" onchange="state.days[${i}].planned=+this.value;save();"></td>
   <td><input type="number" value="${d.produced||0}" onchange="state.days[${i}].produced=+this.value;save();sum();"></td>
   <td><button class="danger small" onclick="state.days.splice(${i},1);save();renderDays();sum();">√ó</button></td>
  </tr>`;
 });
}

// ---- CHANNELS ----
function countPublished(ch){return Object.values(ch.calendar||{}).filter(v=>v).length;}

function renderChannels(){
 let c=document.getElementById("channels");
 c.innerHTML="";
 state.channels.forEach((ch,i)=>{
  if(!ch.calendar)ch.calendar={};
  if(ch.month==null){let n=new Date();ch.month=n.getMonth();ch.year=n.getFullYear();}

  c.innerHTML+=`
  <div class="channel-block">
   <div class="flex-between">
    <input type="text" value="${ch.name||""}" onchange="state.channels[${i}].name=this.value;save();">
    <button class="secondary small" onclick="state.channels[${i}].open=!state.channels[${i}].open;save();renderChannels();">
      ${ch.open?"–°—Ö–æ–≤–∞—Ç–∏":"–ö–∞–ª–µ–Ω–¥–∞—Ä"}
    </button>
    <button class="danger small" onclick="state.channels.splice(${i},1);save();renderChannels();sum();">√ó</button>
   </div>
   <div style="margin-top:4px;font-size:.8rem;color:#9ca3af;">–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ: ${countPublished(ch)}</div>

   <div ${ch.open?"":"style='display:none;'"} class="calendar-wrapper">
     ${drawCal(i)}
   </div>
  </div>`;
 });
}

function drawCal(i){
 let ch=state.channels[i],y=ch.year,m=ch.month;
 let days=new Date(y,m+1,0).getDate(),start=(new Date(y,m,1).getDay()+6)%7;
 let out=`<div class="flex-between">
 <button class="secondary small" onclick="nav(${i},-1)">‚Äπ</button>
 ${["–°—ñ—á–µ–Ω—å","–õ—é—Ç–∏–π","–ë–µ—Ä–µ–∑–µ–Ω—å","–ö–≤—ñ—Ç–µ–Ω—å","–¢—Ä–∞–≤–µ–Ω—å","–ß–µ—Ä–≤–µ–Ω—å","–õ–∏–ø–µ–Ω—å","–°–µ—Ä–ø–µ–Ω—å","–í–µ—Ä–µ—Å–µ–Ω—å","–ñ–æ–≤—Ç–µ–Ω—å","–õ–∏—Å—Ç–æ–ø–∞–¥","–ì—Ä—É–¥–µ–Ω—å"][m]} ${y}
 <button class="secondary small" onclick="nav(${i},1)">‚Ä∫</button>
 </div><table><tr>${["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–ù–¥"].map(d=>`<th>${d}</th>`).join("")}</tr>`;

 let d=1-start;
 for(let r=0;r<6;r++){
  out+="<tr>";
  for(let k=0;k<7;k++){
   if(d<1||d>days)out+="<td></td>";
   else{
    let iso=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    let ok=ch.calendar[iso];
    out+=`<td class="calendar-toggle-cell ${ok?"checked":""}" onclick="toggleDay(${i},'${iso}')">${ok?"‚úì":d}</td>`;
   } d++;
  }
  out+="</tr>";
 }
 return out+"</table>";
}

function nav(i,s){
 let ch=state.channels[i];ch.month+=s;
 if(ch.month<0){ch.month=11;ch.year--;}
 if(ch.month>11){ch.month=0;ch.year++;}
 save();renderChannels();
}
function toggleDay(i,d){let c=state.channels[i];c.calendar[d]=!c.calendar[d];save();renderChannels();sum();}

// ---- SUMMARY ----
function sum(){
 let made=state.days.reduce((a,b)=>a+(b.produced||0),0);
 let published=state.channels.reduce((s,c)=>s+countPublished(c),0);
 let stock=made-published;if(stock<0)stock=0;
 let packs=Math.floor(stock/15);
 let ch=state.channels.length;

 let reserved=Math.max(0,ch*15 - published);
 let extra=Math.max(0,packs-ch);

 // üü¢ –ü–£–ë–õ–Ü–ß–ù–Ü –ü–û–ö–ê–ó–ù–ò–ö–ò
 document.getElementById("stockPublic").textContent=stock;
 document.getElementById("reservedPublic").textContent=reserved;

 // üü° –°–ï–ö–†–ï–¢–ù–Ü –î–ê–ù–Ü –¢–Ü–õ–¨–ö–ò –î–õ–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê
 if(manager){
   document.getElementById("totalMade").textContent=made;
   document.getElementById("totalPublished").textContent=published;
   document.getElementById("packs").textContent=packs;
   document.getElementById("extraChannels").textContent=extra;
 }
}

// ---- INIT ----
document.addEventListener("DOMContentLoaded",()=>{
  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ Firebase, –ø–æ—Ç—ñ–º –º–∞–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  load(function(){
    document.getElementById("normInput").value = state.norm ?? 11;
    renderDays();
    renderChannels();
    sum();
  });

  // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–æ—Ä–º–∏ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ –±–∞–∑–∞ —â–µ –ø—É—Å—Ç–∞)
  document.getElementById("normInput").value = state.norm ?? 11;
  document.getElementById("normInput").oninput=e=>{state.norm=+e.target.value;save();};

  document.getElementById("addDay").onclick=()=>{
   state.days.push({date:"",planned:state.norm,produced:0});save();renderDays();
  };
  document.getElementById("addToday").onclick=()=>{
   state.days.push({date:new Date().toISOString().slice(0,10),planned:state.norm,produced:0});save();renderDays();
  };

  document.getElementById("addChannel").onclick=()=>{
   state.channels.unshift({name:"",open:true,calendar:{},month:null,year:null});
   save();renderChannels();sum();
  };

  document.getElementById("managerBtn").onclick=()=>document.getElementById("passBlock").style.display="block";
  document.getElementById("passOk").onclick=()=>{
    if(document.getElementById("passInput").value==="265024"){
      manager=true;
      document.querySelector(".summary-grid").style.display="grid";
      document.getElementById("passBlock").style.display="none";
      sum();
    } else alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å!");
  };
});
</script>
</body>
</html>
